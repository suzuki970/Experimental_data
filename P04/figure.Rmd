---
title: "Result notes"
author: "Yuta Suzuki"
date: "4/23/2021"
output: 
  slidy_presentation:
    css: style.css
     # reference_docx: results.docx
     # word_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r child="readFunc.Rmd"}
```

## Article information

Experimental data for "Pupillary constriction as an indicator of illusory luminosity perception in the glare illusion"

Yuta Suzuki, Takuya Fujii, Tetsuto Minami, Shigeki Nakauchi

*Corresponding author: Yuta Suzuki
NTT Communication Science Laboratories, NTT Corporation, Atsugi 243-0198, Japan
Tel: +81-046-240-3525 , E-mail: yuuta.suzuki.fc@hco.ntt.co.jp


## Figure 3ab
```{r, message=FALSE, warning=FALSE, echo=FALSE, include=FALSE}

countFigNum = 1
SIZE_FONT=20

#### file loading 
load("data/dataset_e1.rda")
numOfSub = length(unique(data_e1$sub))
sTime = -0.2
eTime = max(data_e1$data_x)

# time course of pupil ---------------------------------------------------
data_e1_ave = aggregate( data_y ~ data_x*Shape*Pattern, data = data_e1, FUN = "mean")

config = list(lim_x = c(sTime, eTime),
              lim_y = c(-0.05, 0.2),
              alpha = 0.4,
              stride = 0.1,
              label_x = "Time [sec]",
              label_y = "Averaged Pupil Changes [mm]",
              title = "",
              grCol = c("#000000","#808080"),
              linetype = FALSE
)

p <- disp(data_e1,config,1,c("Pattern","Shape"))
p <- p + 
  facet_grid(. ~ Shape)

p = setFigureStyle(p)

p <- p + theme(
  legend.position = c(0.9,0.2)
)

eval(parse(text=paste("p", countFigNum ,"=p", sep="")))
countFigNum = countFigNum+1


# mean during time from 0sec to 4sec --------------------------------------
data_e1 = data_e1[data_e1$data_x >= 0,]

# # #### ANOVA
print("-----------------------------------------")
print("          averaged in pupil size         ")
print("-----------------------------------------")
data_e1_anova = aggregate( data_y ~ sub*Pattern*Shape, data = data_e1, FUN = "mean")
anovakun(data_e1_anova,"sAB",gg=T,long=T, peta=T)

#### plot
p <- dispLineGraph(data_e1_anova,config, c("Pattern","Shape"))
# p <- drawSignificance(p,sigPair,0.12,0.015)
p = setBarFigureStyle(p)
p <- p + facet_grid(. ~ Shape)

p <- p + theme(
  axis.title.x = element_blank(),
  axis.text.x = element_blank(),
  axis.ticks.x = element_blank(),
  axis.line.x = element_blank()
)

eval(parse(text=paste("p", countFigNum ,"=p", sep="")))
countFigNum = countFigNum+1

g = c("Kanizsa:radial","Kanizsa:control","No-triangle:radial","No-triangle:control")

numOfSub = length(unique(data_e1_anova$sub))

f = data.frame(
  sub = as.character(unique(data_e1_anova$sub)),
  y = matrix(data_e1_anova$data_y,nrow = numOfSub)
)

colnames(f) <- c("subject",g)
write.csv(f, "data/data_bayesian.csv",row.names=FALSE)

```
```{r, message=FALSE, warning=FALSE, echo=FALSE, fig.height=4, fig.width=10}
# # # figure output -----------------------------------------------------------
p = combineGraphs(seq(1,countFigNum-1),'p',NULL)
plot(p)
```

## Figure 3d
```{r, message=FALSE, warning=FALSE, echo=FALSE, include=FALSE}

countFigNum = 1
SIZE_FONT=20

#### file loading 
load("data/dataset_e2.rda")
numOfSub = length(unique(data_e2$sub))

t.test(data_e2[data_e2$Pattern == 'Radial',]$data_y, mu=0)
t.test(data_e2[data_e2$Pattern == 'Control',]$data_y, mu=0)

# ANOVA -------------------------------------------------------------------
anovakun(data_e2,"sA",gg=T,long=T, peta=T)

# ### bar plot
config <- list(lim_x = c(0.5,7.5),
               lim_y = c(0,6),
               label_x = "",
               label_y = "Adjusted luminance [%]",
               title="average",
               grCol = c("#000000","#FFFFFF","#FFFFFF"),
               gr_outline = rep(c("#000000"),8)
)

p <- dispBarGraph(data_e2,config,c("Pattern"))+
  scale_y_continuous(breaks = seq(0,5),expand = c(0, 0.5))

p = setBarFigureStyle(p)

p <- p + theme(
  axis.title.x = element_blank(),
  legend.position = 'none',
  axis.ticks.x = element_blank(),
  axis.line.x = element_blank()
)
eval(parse(text=paste("p", countFigNum ,"=p", sep="")))
countFigNum = countFigNum+1

g = c("Kanizsa:radial","Kanizsa:control")

numOfSub = length(unique(data_e2$sub))

f = data.frame(
  sub = as.character(unique(data_e2$sub)),
  y = matrix(data_e2$data_y,nrow = numOfSub)
)

colnames(f) <- c("subject",g)
write.csv(f, "data/data_e2_bayesian.csv",row.names=FALSE)

# coorelation -------------------------------------------------------------
load('data/dataset_e1.rda')
load('data/dataset_e2.rda')

data_e1e2 = data_e1_anova[data_e1_anova$Shape == 'Kanizsa',]
data_e1e2$data_y_e2 = data_e2$data_y
data_e1e2 = data_e1e2[data_e1e2$sub != 5,]

res = lm( data_y ~ data_y_e2 , data = data_e1e2)
print(summary(res))
cor.test(data_e1e2$data_y,data_e1e2$data_y_e2,method='spearman')

p <- ggplot(data_e1e2,aes(x = data_y_e2, y = data_y)) +
  geom_point(color='black',size=2)+
  geom_abline(intercept = summary(res)$coefficients[1,"Estimate"],
              slope = summary(res)$coefficients[2,"Estimate"],
              color='gray',size=1)+
  
  coord_cartesian(xlim = c(-1, 9), ylim =  c(-0.2, 0.4)) +
  xlab("Adjusted luminance [%]") + ylab(config$label_y)

p = setFigureStyle(p)
p <- p + theme(
  legend.position = c(0.9,0.9)
)

eval(parse(text=paste("p", countFigNum ,"=p", sep="")))
countFigNum = countFigNum+1

```
```{r, message=FALSE, warning=FALSE, echo=FALSE, fig.height=4, fig.width=10}
# # # figure output -----------------------------------------------------------
p = combineGraphs(seq(1,countFigNum-1),'p',NULL)
plot(p)
```

## Figure 4
```{r, message=FALSE, warning=FALSE, echo=FALSE, include=FALSE}

CairoFonts(regular = "Times","Times")

sTime = -0.2
eTime = 4
countFigNum = 1
fontSize = 20

#### file loading 
load("data/dataset_e3.rda")
numOfSub = length(unique(data_e1$sub))
data_e1$sub = subName[data_e1$sub]

### show graph
data_e1_ave = aggregate( data_y ~ sub*Angle*Pattern*data_x, data = data_e1, FUN = "mean")
data_e1_ave = data_e1_ave[data_e1_ave$Pattern!='Uniform',]

data_e1_0deg = data_e1[data_e1$Pattern == 'Uniform',]
data_e1_0deg = aggregate( data_y ~ Angle*Pattern*data_x, data = data_e1_0deg, FUN = "mean")
data_e1_0deg = rbind(data_e1_0deg,data_e1_0deg,data_e1_0deg,data_e1_0deg,
                     data_e1_0deg,data_e1_0deg,data_e1_0deg,data_e1_0deg)

config = list(lim_x = c(sTime, eTime),
              lim_y = c(-0.5, 0.1),
              alpha = 0.4,
              stride = 0.1,
              label_x = "Time [sec]",
              label_y = "Pupil Changes [mm]",
              title = "(a)",
              grCol = rep(c("black", "gray16", "gray32", "gray48"),2),
              linetype = FALSE
)

p <- disp(data_e1_ave,config,1,c("Pattern","Angle")) +
  geom_line(aes(x = data_e1_0deg$data_x, y = data_e1_0deg$data_y),color='gray')

p <- p + facet_grid(Angle ~ .)

p = setFigureStyle(p)

p <- p + theme(
  legend.position = 'none'
)

eval(parse(text=paste("p", countFigNum ,"=p", sep="")))
countFigNum = countFigNum+1

# # ############# ANOVA ########################
print("-----------------------------------------")
print("           averaged pupil size           ")
print("-----------------------------------------")
data_e1_ave = data_e1_ave[data_e1_ave$data_x >= 0,]
data_e1_anova = aggregate( data_y ~ sub*Angle*Pattern, data = data_e1_ave, FUN = "mean")

anovakun(data_e1_anova,"sAB",gg=T,long=T, peta=T)

# bar plot ----------------------------------------------------------------
config <- list(lim_x = c(0.5,7.5),
               lim_y = c(-0.2,0),
               stride =c(-0.2,-0.1,-0.0,0.1,0.2),
               label_x = "",
               label_y = "Averaged Pupil Changes [mm]",
               title="average",
               grCol = rep(c("black", "gray16", "gray32", "gray48"),2)
)

data_e1_box = aggregate( data_y ~ sub*Angle*Pattern, data = data_e1, FUN = "mean")

p <- ggplot(data_e1_box,aes(x =Pattern,color =Angle,  y = data_y))+
  geom_boxplot(aes(linetype=Pattern))+
  scale_fill_manual(values = config$grCol)+
  scale_color_manual(values = config$grCol)+
  ylab(config$label_y)+
  facet_grid(. ~ Angle)

p = setBarFigureStyle(p)

p <- p + theme(
  legend.position = 'none'
)

eval(parse(text=paste("p", countFigNum ,"=p", sep="")))
countFigNum = countFigNum+1

# task ----------------------------------------------------------------
g <- c("Glare:0.97", "Glare:0.84", "Glare:0.56", "Glare:0.46", "0",
       "Halo:0.97", "Halo:0.84", "Halo:0.56", "Halo:0.46")

numOfSub = length(unique(data_e1_box$sub))

f = data.frame(
  sub = as.character(unique(data_e1_box$sub)),
  y = matrix(data_e1_box$data_y,nrow = numOfSub)
)

colnames(f) <- c("subject",g)
write.csv(f, "data/e3_bayesian.csv",row.names=FALSE)

load("data/dataset_e3.rda")

sd_task = aggregate( data_y ~ Angle*Pattern, data = data_task, FUN = "sd")
sd_task$data_y = sd_task$data_y / sqrt(numOfSub)

data_task_ave = aggregate( data_y ~ Angle*Pattern, data = data_task, FUN = "mean")
data_task_anova = aggregate( data_y ~ sub*Angle*Pattern, data = data_task, FUN = "mean")
data_task_ave$SE_min_task  = data_task_ave$data_y - sd_task$data_y
data_task_ave$SE_max_task  = data_task_ave$data_y + sd_task$data_y

g1 =  c(0.97,0.84,0.56,0.46,0,-0.46,-0.56,-0.84,-0.97)
g0 = c(58,54,42,38,0,-38,-42,-54,-58)
g2 =  c("a","b","c","d","e","a","b","c","d")

for(i in 1:length(g0)){
  data_task[data_task$cell == g0[i],]$cell = g1[i]
}

allfit = data.frame()
for(iSub in 1:max(data_task$sub)){
  if(dim(data_task[data_task$sub == iSub,])[1] > 0){
    tmp_fit = quickpsy(data_task[data_task$sub == iSub,], cell, data_y, n)
    tmp_fit = data.frame(
      sub = iSub,
      x = tmp_fit$curves$x,
      y = tmp_fit$curves$y
    )
    allfit = rbind(allfit,tmp_fit)
  }
}

fNum = 0.75
th = NULL
for(iSub in 1:max(data_task$sub)){
  if(dim(allfit[allfit$sub == iSub,])[1] > 0){
    ind = which( abs(allfit[allfit$sub == iSub,]$y-fNum) == min(abs(allfit[allfit$sub == iSub,]$y-fNum))) 
    th = rbind(th,allfit[allfit$sub == iSub,]$x[ind])
  }
}

ind = order(th)
mmName = unique(allfit$sub)
data_e1_ave = aggregate( data_y ~ sub*Angle*Pattern*data_x, data = data_e1, FUN = "mean")
data_e1_ave = data_e1_ave[data_e1_ave$data_x >= 0,]
data_e1_ave = aggregate( data_y ~ sub*Angle*Pattern, data = data_e1_ave, FUN = "mean")
data_e1_ave$group = ''
allfit$group = ''
for(iRoop in 1:length(ind)){ 
  if(iRoop < length(ind)/2+1){
    data_e1_ave[data_e1_ave$sub == mmName[ind[iRoop]],]$group = 'low'
    allfit[allfit$sub == mmName[ind[iRoop]],]$group = 'low'
  }else{
    data_e1_ave[data_e1_ave$sub == mmName[ind[iRoop]],]$group = 'high'
    allfit[allfit$sub == mmName[ind[iRoop]],]$group = 'high'
  }
}

fit <- quickpsy(data_task, cell, data_y, n)
data_task_ave$Angle = g1
data_task_anova = data_task_anova[order(data_task_anova$sub),]
data_task_anova$Angle = g1
data_e1_ave = data_e1_ave[order(data_e1_ave$sub),]
data_e1_ave$Angle = g2
allfit$sub = subName[allfit$sub]
p <- ggplot(data_task_ave,aes(x = Angle, y = data_y )) +
  geom_errorbar(aes(ymin = SE_min_task, ymax = SE_max_task),width = 0.001, size=0.2) +
  geom_point(aes(shape = Pattern,color = Angle,fill=Angle), size = 2)+
  geom_point(data=data_task_anova,aes(shape = Pattern,color = Angle,fill=Angle), size = 1,alpha=0.4)+
  xlab('Luminance contrast')+
  ylab('Probability')+
  geom_line(data = fit$curves, aes(x = x, y = y))+
  geom_line(data = allfit, aes(x = x, y = y,group=interaction(group,sub)),alpha=0.4)+
  facet_grid(. ~ group)
  # scale_color_gradient(low = "black", high = "gray80") 

p = setBarFigureStyle(p)
eval(parse(text=paste("p", countFigNum ,"=p", sep="")))
countFigNum = countFigNum+1

p <- dispLineGraph(data_e1_ave,config,c("Pattern","Angle","group"))+
# ggplot(data_e1_ave,aes(x =Pattern,color = Angle,  y = data_y))+
#   geom_boxplot(aes(linetype=Pattern))+
#   scale_fill_manual(values = config$grCol)+
#   scale_color_manual(values = config$grCol)+
#   ylab(config$label_y)+
  facet_grid(group ~ Angle)
p <- p + theme(
  legend.position = 'none'
)
p = setBarFigureStyle(p)
eval(parse(text=paste("p", countFigNum ,"=p", sep="")))
countFigNum = countFigNum+1

data_e1_ave = data_e1_ave[,c(1,2,3,5,4)]
data_e1_ave$sub = subName[data_e1_ave$sub]
data_e1_ave = data_e1_ave[data_e1_ave$Pattern != 'Uniform',]
# anovakun(data_e1_ave,"AsBC",gg=T,long=T, peta=T)

t = data_e1_ave[data_e1_ave$group == 'low',]
t$group = NULL
anovakun(t,"sAB",gg=T,long=T, peta=T)

numOfSub = length(unique(t$sub))
f = data.frame(
  sub = as.character(unique(t$sub)),
  y = t(matrix(t$data_y,ncol = numOfSub))
)
g <- c("Glare:0.97", "Glare:0.84", "Glare:0.56", "Glare:0.46","Halo:0.97", "Halo:0.84", "Halo:0.56", "Halo:0.46")
colnames(f) <- c("subject",g)
write.csv(f, "data/e3_bayesian_low.csv",row.names=FALSE)

t = data_e1_ave[data_e1_ave$group == 'high',]
t$group = NULL
anovakun(t,"sAB",gg=T,long=T, peta=T)
numOfSub = length(unique(t$sub))
f = data.frame(
  sub = as.character(unique(t$sub)),
  y = t(matrix(t$data_y,ncol = numOfSub))
)
colnames(f) <- c("subject",g)
write.csv(f, "data/e3_bayesian_high.csv",row.names=FALSE)

# width_fig=10
# height_fig=6
# CairoPDF("group",
#          width=width_fig, height=height_fig)
# print(p)
# dev.off()
# 
# width_fig=6
# height_fig=5
# CairoPDF("psych_curve",
#          width=width_fig, height=height_fig)
# print(p3)
# dev.off()
```

```{r, message=FALSE, warning=FALSE, echo=FALSE, fig.height=10, fig.width=10}
## figure output -----------------------------------------------------------
p = combineGraphs(seq(1,countFigNum-1),'p',NULL)
plot(p)
```